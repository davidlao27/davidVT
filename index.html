<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Include Handsfree.js -->
    <link rel="stylesheet" href="https://unpkg.com/handsfree@8.5.1/build/lib/assets/handsfree.css" />
    <script src="https://unpkg.com/handsfree@8.5.1/build/lib/handsfree.js"></script>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>davidVT</title>
    <style>
        .body {
            margin: 0;
            overflow: hidden;
            font-family: Verdana, Geneva, Tahoma, sans-serif;
        }

        .btmnav p {
            float: left;
            color: #f2f2f2;
            text-align: center;
            padding: 10px 16px;
            text-decoration: none;
            font-size: 17px;
            -webkit-filter: drop-shadow(5px 5px 2px #000);
            filter: drop-shadow(5px 5px 2px #000);
        }

        .btmnav a:hover {
            background-color: #ddd;
            color: black;
        }

        .btmnav a.active {
            background-color: #4CAF50;
            color: white;
        }

        .btmnav {
            overflow-y: visible;
            font-size: large;
            width: 30vw;
            height: 90vh;
            overflow: hidden;
            background-color: rgba(238, 238, 238, 0.8);
            box-shadow: 0px 3px 10px 2px #000000;
            position: absolute;
            z-index: 1;
            padding: 4vh;
        }

        .vtimg {
            /* Full height */
            position: absolute;
            height: 100%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);

            /* Center and scale the image nicely */
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
        }

        .recotxt {
            position: absolute;
            text-align: center;
            top: 90%;
            left: 50%;
            transform: translate(-50%, -90%);
            font-size: larger;
            color: white;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
        }

        .hidbtn {
            opacity: 0;
            padding: 10px;
            position: absolute;
            top: 5vh;
            left: 2vw;
            transform: translate(-50%, -90%);
        }
    </style>
</head>

<body bgcolor="#0F0">
    <img src="close.png" id="vtpic" class="vtimg"></img>
    <div class="btmnav" id="btmnav" style="visibility: hidden;">
        <button onclick="hideMenu();">Back</button><br><br>
        || Settings ||<br><br>
        <input type="checkbox" id="chkjarvis">Jarvis Mode</input><br>
        <input type="checkbox" id="chksubs">Subtitles</input><br><br>
        Language<br>
        <input type="text" placeholder="en-EN, es-ES..." id="chklang"></input><br><br>

        <div>Volume</div>
        <input type="text" placeholder="Normal value (talking)" id="chkvoln"><br>
        <input type="text" placeholder="Loud value (screaming)" id="chkvoll"><br>
        <small>right now: <font id="volstr">--</font></small><br><br>
        URLs<br>
        <input type="text" placeholder="Open mouth" id="chkopen"><br>
        <input type="text" placeholder="Closed mouth" id="chkclose"><br>
        <input type="text" placeholder="Open loud mouth" id="chkol"><br>
        <input type="text" placeholder="Smile mouth (opt)" id="chksmi"><br>
        <input type="text" placeholder="Jarvis closed mouth" id="chkjc"><br>
        <input type="text" placeholder="Jarvis open mouth" id="chkjo"><br>
        <input type="text" placeholder="Eyes closed, closed mouth" id="chkec"><br>
        <input type="text" placeholder="Eyes closed, open mouth" id="chkeo"><br>
        <br>
        <button onclick="applySettingsMenu();">Apply changes</button><br>
    </div>
    <br>
    <div class="hidbtn" onclick="openMenu();">Menu</div>
    <div id="output" class="recotxt">[...]</div>
    <script>
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);

        var jarvismode = false; var jarviscomm = false; canJarvis = true;
        var nvol = 11; var lvol = 70;

        if (urlParams.get("jmode") == "false") { canJarvis = false; }
        if (urlParams.get("subs") == "true") { document.getElementById("output").style.display = "initial"; }
        if (urlParams.get("nvol") != null) { nvol = urlParams.get("nvol"); }
        if (urlParams.get("lvol") != null) { lvol = urlParams.get("lvol"); }

        const handsfree = new Handsfree({ weboji: true });
        handsfree.start();

        var joimg = urlParams.get("jarviso");
        var jcimg = urlParams.get("jarvisc");

        if (joimg == null) joimg = "jarviso.png";
        if (jcimg == null) jcimg = "jarvisc.png";

        const vtpic = document.getElementById("vtpic");
        const velem = document.getElementById("vol");

        const volstr = document.getElementById("volstr");

        var opimg = urlParams.get("open");
        var climg = urlParams.get("close");
        var smimg = urlParams.get("smile");
        var oplimg = urlParams.get("openloud");

        var eccimg = urlParams.get("eyescc");
        var ecoimg = urlParams.get("eyesco");


        navigator.mediaDevices.getUserMedia({
            audio: true,
            video: true
        })
            .then(function (stream) {
                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                const scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);

                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;

                microphone.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                scriptProcessor.onaudioprocess = function () {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    const arraySum = array.reduce((a, value) => a + value, 0);
                    const average = arraySum / array.length;
                    let eyesc, smil;

                    let vol = Math.round(average);
                    volstr.innerHTML = vol;

                    if (handsfree.data != undefined) {
                        eyesc = handsfree.data.weboji.state.eyesClosed;
                        smil = handsfree.data.weboji.state.smile;
                    }

                    if (urlParams.get('close') && urlParams.get('open') && urlParams.get('openloud') && urlParams.get('eyescc') && urlParams.get('eyesco') && urlParams.get('openloud')) {
                        if (!smimg) smimg = climg;

                        if (eyesc == false) {
                            if (vol > 0 && vol < nvol) {
                                if (jarvismode) {
                                    vtpic.src = jcimg;
                                } else if (smil == false) {
                                    vtpic.src = climg;
                                } else {
                                    vtpic.src = smimg;
                                }
                            } else if (vol > nvol && vol < lvol) {
                                if (jarvismode) {
                                    vtpic.src = joimg;
                                } else {
                                    vtpic.src = opimg;
                                }
                            } else if (vol > lvol) {
                                if (jarvismode) {
                                    vtpic.src = joimg;
                                } else {
                                    vtpic.src = oplimg;
                                }
                            }
                        } else {
                            if (vol > 0 && vol < nvol) {
                                if (jarvismode) {
                                    vtpic.src = jcimg;
                                } else {
                                    vtpic.src = eccimg;
                                }
                            } else if (vol > nvol && vol < lvol) {
                                if (jarvismode) {
                                    vtpic.src = joimg;
                                } else {
                                    vtpic.src = ecoimg;
                                }
                            } else if (vol > lvol) {
                                if (jarvismode) {
                                    vtpic.src = joimg;
                                } else {
                                    vtpic.src = oplimg;
                                }
                            }
                        }
                    } else {
                        if (eyesc == false) {
                            if (vol > 0 && vol < nvol) {
                                if (jarvismode) {
                                    vtpic.src = jcimg;
                                } else if (smil == false) {
                                    vtpic.src = "close.png";
                                } else {
                                    vtpic.src = "smile.png";
                                }
                            } else if (vol > nvol && vol < lvol) {
                                if (jarvismode) {
                                    vtpic.src = joimg;
                                } else {
                                    vtpic.src = "open.png";
                                }
                            } else if (vol > lvol) {
                                if (jarvismode) {
                                    vtpic.src = joimg;
                                } else {
                                    vtpic.src = "openloud.png";
                                }
                            }
                        } else {
                            if (vol > 0 && vol < nvol) {
                                if (jarvismode) {
                                    vtpic.src = joimg;
                                } else {
                                    vtpic.src = "eyescc.png";
                                }
                            } else if (vol > nvol && vol < lvol) {
                                if (jarvismode) {
                                    vtpic.src = joimg;
                                } else {
                                    vtpic.src = "eyesco.png";
                                }
                            } else if (vol > lvol) {
                                if (jarvismode) {
                                    vtpic.src = joimg;
                                } else {
                                    vtpic.src = "openloud.png";
                                }
                            }
                        }
                    }
                };
            })
            .catch(function (err) {
                /* handle the error */
                console.error(err);
            });

        var recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        const recolang = urlParams.get("lang");
        if (recolang == null) {
            recognition.lang = "en-US";
        } else {
            recognition.lang = recolang;
        }

        recognition.onerror = function (event) {
            console.error(event);
        };

        recognition.onstart = function () {
        };

        recognition.onend = function () {
            recognition.start();
        };

        recognition.onresult = function (event) {
            var interim_transcript = '';
            var final_transcript = '';

            for (var i = event.resultIndex; i < event.results.length; ++i) {
                // Verify if the recognized text is the last with the isFinal property
                if (event.results[i].isFinal) {
                    final_transcript += event.results[i][0].transcript;
                } else {
                    interim_transcript += event.results[i][0].transcript;
                }
            }

            // Choose which result may be useful for you
            document.getElementById("output").innerHTML = final_transcript;

            if (canJarvis) {
                if (final_transcript.includes("hey David disable subtitles") || final_transcript.includes("oye David desactiva los subtítulos") || final_transcript.includes("oye David desactivar los subtítulos")) {
                    document.getElementById("output").style.display = "none";
                    jarvismode = false;
                } else if (final_transcript.includes("hey David enable subtitles") || final_transcript.includes("oye David activa los subtítulos") || final_transcript.includes("oye David activar los subtítulos")) {
                    document.getElementById("output").style.display = "initial";
                    jarvismode = false;
                } else if (final_transcript.includes("hey David") || final_transcript.includes("oye David")) {
                    jarvismode = true;
                } else if (final_transcript.includes("disable subtitles") || final_transcript.includes("desactiva los subtítulos") ) {
                    if (jarvismode) {
                        document.getElementById("output").style.display = "none";
                        jarvismode = false;
                    }
                } else if (final_transcript.includes("enable subtitles") || final_transcript.includes("activa los subtítulos")) {
                    if (jarvismode) {
                        document.getElementById("output").style.display = "initial";
                        jarvismode = false;
                    }
                } else if (final_transcript.includes("nevermind David") || final_transcript.includes("never mind David") || final_transcript.includes("no importa David") || final_transcript.includes("não importa Davi")) {
                    jarvismode = false;
                }
            }
        };

        recognition.start();

        const cmenu = document.getElementById("btmnav");
        const btnmenu = document.getElementById("hidbtn");

        const jarvischk = document.getElementById("chkjarvis");
        const subsschk = document.getElementById("chksubs");

        const langchk = document.getElementById("chklang");

        const nvolchk = document.getElementById("chkvoln");
        const lvolchk = document.getElementById("chkvoll");

        const chkopen = document.getElementById("chkopen");
        const chkclose = document.getElementById("chkclose");
        const chkol = document.getElementById("chkol");

        const chkjc = document.getElementById("chkjc");
        const chkjo = document.getElementById("chkjo");

        const chkec = document.getElementById("chkec");
        const chkeo = document.getElementById("chkeo");
        const chksmi = document.getElementById("chksmi");

        function openMenu() {
            cmenu.style.visibility = "visible";
            btnmenu.style.visibility = "hidden";
        }

        function hideMenu() {
            cmenu.style.visibility = "hidden";
            btnmenu.style.visibility = "visible";
        }

        function applySettingsMenu() {
            window.location.replace("https://davidlao27.github.io/davidVT?close=" + chkclose.value + "&open=" + chkopen.value + "&eyescc=" + chkec.value + "&eyesco=" + chkeo.value + "&openloud=" + chkol.value + "&smile=" + chksmi.value + "&jarvisc=" + chkjc.value + "&jarviso=" + chkjo.value + "&jmode=" + jarvischk.checked + "&nvol=" + nvolchk.value + "&lvol=" + lvolchk.value + "&subs=" + subsschk.checked);
        }
    </script>
</body>

</html>