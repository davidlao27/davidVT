<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Include Handsfree.js -->
  <link rel="stylesheet" href="https://unpkg.com/handsfree@8.5.1/build/lib/assets/handsfree.css" />
  <script src="https://unpkg.com/handsfree@8.5.1/build/lib/handsfree.js"></script>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>davidVT</title>
    <style>
        .body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, Helvetica, sans-serif;
        }

        .vtimg {
            /* Full height */
            position: absolute;
            height: 100%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);

            /* Center and scale the image nicely */
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
        }

        .recotxt {
            position: absolute;
            text-align: center;
            top: 90%;
            left: 50%;
            transform: translate(-50%, -90%);
            font-size: larger;
            color: white;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
        }
    </style>
</head>

<body bgcolor="#0F0">
    <img src="close.png" id="vtpic" class="vtimg"></img>
    <div id="output" class="recotxt">[...]</div>
    <script>
        var jarvismode = false; var jarviscomm = false;
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        
        const handsfree = new Handsfree({weboji: true});
        handsfree.start();

        var joimg = urlParams.get("jarviso");
        var jcimg = urlParams.get("jarvisc");

        if (joimg == null) joimg="jarviso.png";
        if (jcimg == null) jcimg="jarvisc.png";


        navigator.mediaDevices.getUserMedia({
            audio: true,
            video: true
        })
            .then(function (stream) {
                const vtpic = document.getElementById("vtpic");
                const velem = document.getElementById("vol");
                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                const scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);

                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;

                microphone.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                scriptProcessor.onaudioprocess = function () {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    const arraySum = array.reduce((a, value) => a + value, 0);
                    const average = arraySum / array.length;
                    let eyesc, smil;

                    let vol = Math.round(average);
                    //console.log(vol)
            
                    if (handsfree.data != undefined) {
                        eyesc = handsfree.data.weboji.state.eyesClosed;
                        smil = handsfree.data.weboji.state.smile;
                    }

                    if (urlParams.get('close') && urlParams.get('open') && urlParams.get('openloud') && urlParams.get('eyescc') && urlParams.get('eyesco') && urlParams.get('openloud')) {
                        var opimg = urlParams.get("open");
                        var climg = urlParams.get("close");
                        var smimg = urlParams.get("smile");
                        var oplimg = urlParams.get("openloud");

                        var eccimg = urlParams.get("eyescc");
                        var ecoimg = urlParams.get("eyesco");

                        if (!smimg) smimg=climg;

                        console.log(joimg,jcimg)

                        if (eyesc == false) {
                        if (vol > 0 && vol < 11) {
                            if (jarvismode) {
                                vtpic.src = jcimg;
                            } else if (smil == false) {
                                vtpic.src = climg;
                            } else {
                                vtpic.src = smimg;
                            }
                        } else if (vol > 11 && vol < 70) {
                            if (jarvismode) {
                                vtpic.src = joimg;
                            } else {
                                vtpic.src = opimg;
                            }
                        } else if (vol > 70) {
                            if (jarvismode) {
                                vtpic.src = joimg;
                            } else {
                                vtpic.src = oplimg;
                            }
                        }
                    } else {
                        if (vol > 0 && vol < 11) {
                            if (jarvismode) {
                                vtpic.src = jcimg;
                            } else {
                                vtpic.src = eccimg;
                            }
                        } else if (vol > 11 && vol < 70) {
                            if (jarvismode) {
                                vtpic.src = joimg;
                            } else {
                                vtpic.src = ecoimg;
                            }
                        } else if (vol > 70) {
                            if (jarvismode) {
                                vtpic.src = joimg;
                            } else {
                                vtpic.src = oplimg;
                            }
                        }
                    }
                    } else {
                        if (eyesc == false) {
                        if (vol > 0 && vol < 11) {
                            if (jarvismode) {
                                vtpic.src = jcimg;
                            } else if (smil == false) {
                                vtpic.src = "close.png";
                            } else {
                                vtpic.src = "smile.png";
                            }
                        } else if (vol > 11 && vol < 70) {
                            if (jarvismode) {
                                vtpic.src = joimg;
                            } else {
                                vtpic.src = "open.png";
                            }
                        } else if (vol > 70) {
                            if (jarvismode) {
                                vtpic.src = joimg;
                            } else {
                                vtpic.src = "openloud.png";
                            }
                        }
                    } else {
                        if (vol > 0 && vol < 11) {
                            if (jarvismode) {
                                vtpic.src = joimg;
                            } else {
                                vtpic.src = "eyescc.png";
                            }
                        } else if (vol > 11 && vol < 70) {
                            if (jarvismode) {
                                vtpic.src = joimg;
                            } else {
                                vtpic.src = "eyesco.png";
                            }
                        } else if (vol > 70) {
                            if (jarvismode) {
                                vtpic.src = joimg;
                            } else {
                                vtpic.src = "openloud.png";
                            }
                        }
                    }
                    }
                };
            })
            .catch(function (err) {
                /* handle the error */
                console.error(err);
            });

            var recognition = new webkitSpeechRecognition();
recognition.continuous = true;
recognition.interimResults = true;
recognition.lang = "en-US";

recognition.onerror = function(event) {
    console.error(event);
};

recognition.onstart = function() {
    console.log('Speech reco started');
};

recognition.onend = function() {
    console.log('Speech reco disconnected');
    recognition.start();
};

recognition.onresult = function(event) {
    var interim_transcript = '';
    var final_transcript = '';

    for (var i = event.resultIndex; i < event.results.length; ++i) {
        // Verify if the recognized text is the last with the isFinal property
        if (event.results[i].isFinal) {
            final_transcript += event.results[i][0].transcript;
        } else {
            interim_transcript += event.results[i][0].transcript;
        }
    }

    // Choose which result may be useful for you
        document.getElementById("output").innerHTML = final_transcript;

    if (final_transcript.includes("hey David")) {
        jarvismode = true;
    } else if (final_transcript.includes("turn off speech")) {
        if (jarvismode)
            document.getElementById("output").innerHTML = "ok! (reloading)";
    } else if (final_transcript.includes("hide subtitles")) {
        if (jarvismode) {
            document.getElementById("output").style.display = "none";
            jarvismode = false;
        }
    } else if (final_transcript.includes("show subtitles")) {
        if (jarvismode) {
            document.getElementById("output").style.display = "initial";
            jarvismode = false;
        }
    } else if (final_transcript.includes("nevermind David") || final_transcript.includes("never mind David")) {
        jarvismode = false;
    }
};

recognition.start();
    </script>
</body>

</html>